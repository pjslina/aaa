<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.mapper.OpMetricMapper">

    <!-- ==================== ResultMap定义 ==================== -->

    <!-- 度量ResultMap -->
    <resultMap id="MeasureResultMap" type="org.example.entity.OpMeasure">
        <id property="id" column="id"/>
        <result property="measureCode" column="measure_code"/>
        <result property="enName" column="en_name"/>
        <result property="cnName" column="cn_name"/>
        <result property="unit" column="unit"/>
        <result property="fixedValue" column="fixed_value"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <!-- 指标ResultMap -->
    <resultMap id="MetricResultMap" type="org.example.entity.OpMetric">
        <id property="metricId" column="metric_id"/>
        <result property="metricCode" column="metric_code"/>
        <result property="metricName" column="metric_name"/>
        <result property="currency" column="currency"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <!-- ==================== 查询所有指标ID ==================== -->
    <select id="selectAllMetricIds" resultType="java.lang.Long">
        SELECT metric_id
        FROM op_metric
        WHERE status = '1'
        ORDER BY metric_id
    </select>

    <!-- ==================== 查询指标基本信息 ==================== -->
    <select id="selectMetricsByIds" resultMap="MetricResultMap">
        SELECT
            metric_id,
            metric_code,
            metric_name,
            currency,
            status,
            create_time,
            update_time
        FROM op_metric
        WHERE status = '1'
        <if test="metricIds != null and metricIds.size() > 0">
            AND metric_id IN
            <foreach collection="metricIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        ORDER BY metric_id
    </select>

    <!-- ==================== 查询单个指标的度量列表 ==================== -->
    <select id="selectMeasuresByMetricId" resultMap="MeasureResultMap">
        SELECT
            m.id,
            m.measure_code,
            m.en_name,
            m.cn_name,
            m.unit,
            m.fixed_value,
            m.status,
            m.create_time,
            m.update_time
        FROM op_measure m
        INNER JOIN op_metric_rel r ON m.id = r.rel_id
        WHERE r.metric_id = #{metricId}
          AND r.rel_type = 3
          AND r.status = '1'
          AND m.status = '1'
        ORDER BY m.id
    </select>

    <!-- ==================== 批量查询指标的度量列表 ==================== -->
    <select id="selectMeasuresByMetricIds" resultMap="MeasureResultMap">
        SELECT
            r.metric_id,
            m.id,
            m.measure_code,
            m.en_name,
            m.cn_name,
            m.unit,
            m.fixed_value,
            m.status,
            m.create_time,
            m.update_time
        FROM op_measure m
        INNER JOIN op_metric_rel r ON m.id = r.rel_id
        WHERE r.rel_type = 3
          AND r.status = '1'
          AND m.status = '1'
        <if test="metricIds != null and metricIds.size() > 0">
            AND r.metric_id IN
            <foreach collection="metricIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        ORDER BY r.metric_id, m.id
    </select>

    <!-- ==================== 查询单个指标的域编码列表 ==================== -->
    <select id="selectDomainCodesByMetricId" resultType="java.lang.String">
        SELECT
            d.domain_code
        FROM op_metric_domain d
        INNER JOIN op_metric_rel r ON d.id = r.rel_id
        WHERE r.metric_id = #{metricId}
          AND r.rel_type = 1
          AND r.status = '1'
          AND d.status = '1'
        ORDER BY d.domain_code
    </select>

    <!-- ==================== 批量查询指标的域编码列表 ==================== -->
    <select id="selectDomainCodesByMetricIds" resultType="java.util.HashMap">
        SELECT
            r.metric_id,
            d.domain_code
        FROM op_metric_domain d
        INNER JOIN op_metric_rel r ON d.id = r.rel_id
        WHERE r.rel_type = 1
          AND r.status = '1'
          AND d.status = '1'
        <if test="metricIds != null and metricIds.size() > 0">
            AND r.metric_id IN
            <foreach collection="metricIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        ORDER BY r.metric_id, d.domain_code
    </select>

    <!-- ==================== 查询单个指标的组织层级列表 ==================== -->
    <select id="selectOrgLevelsByMetricId" resultType="java.lang.String">
        SELECT
            o.org_level
        FROM op_metric_org o
        INNER JOIN op_metric_rel r ON o.id = r.rel_id
        WHERE r.metric_id = #{metricId}
          AND r.rel_type = 2
          AND r.status = '1'
          AND o.status = '1'
        ORDER BY o.org_level
    </select>

    <!-- ==================== 批量查询指标的组织层级列表 ==================== -->
    <select id="selectOrgLevelsByMetricIds" resultType="java.util.HashMap">
        SELECT
            r.metric_id,
            o.org_level
        FROM op_metric_org o
        INNER JOIN op_metric_rel r ON o.id = r.rel_id
        WHERE r.rel_type = 2
          AND r.status = '1'
          AND o.status = '1'
        <if test="metricIds != null and metricIds.size() > 0">
            AND r.metric_id IN
            <foreach collection="metricIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        ORDER BY r.metric_id, o.org_level
    </select>

</mapper>